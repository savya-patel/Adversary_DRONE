# USB LiDAR SLAM - Quick Start

SICK TiM561 LiDAR + SLAM Toolbox over USB (no Ethernet, no odometry needed).

## ‚ö° Quick Start

**Terminal 1 - SLAM:**
```bash
cd ~/Adversary_DRONE/slam_ws
sudo bash -c "source /opt/ros/humble/setup.bash && source install/setup.bash && ros2 launch slam_config slam_usb.launch.py"
```

**Terminal 2 - Visualize (pick one):**
```bash
# Web viewer (no X11, works over SSH):
cd ~/Adversary_DRONE/slam_ws && ./run_rosboard_sudo.sh
# Then open: http://<jetson-ip>:8888

# OR - LiDAR scan GUI:
cd ~/Adversary_DRONE/slam_ws
source /opt/ros/humble/setup.bash && source install/setup.bash
python3 lidar_scan_viewer.py
```

**Expected output:**
- ‚úÖ `USB bulk connected (IN=0x81, OUT=0x02)` or `USB serial connected at /dev/ttyACM0`
- ‚úÖ `Publishing scan: 271 points`
- ‚úÖ `Registering sensor: [Custom Described Lidar]`

---

## Visualization Options

### 1. Rosboard (Web-based - Best for SSH)
```bash
cd ~/Adversary_DRONE/slam_ws && ./run_rosboard_sudo.sh
# Access: http://10.250.240.81:8888
```
View topics: `/scan` (radar), `/map` (SLAM grid)

### 2. LiDAR Scan Viewer (GUI)
```bash
cd ~/Adversary_DRONE/slam_ws
source /opt/ros/humble/setup.bash && source install/setup.bash
python3 lidar_scan_viewer.py
```
Shows: Real-time scan points, orientation, range, 270¬∞ FOV visualization

### 3. RViz (Local)
```bash
cd ~/Adversary_DRONE/slam_ws
source /opt/ros/humble/setup.bash && source install/setup.bash
rviz2 -d src/slam_config/rviz/slam_tim561.rviz
```

---

## Verify Working

**Check map exists:**
```bash
sudo -E bash -c "source /opt/ros/humble/setup.bash && source install/setup.bash && ros2 service call /slam_toolbox/dynamic_map nav_msgs/srv/GetMap '{}'" | grep -A2 "width\|height"
```
Should show: `width: 126`, `height: 112`, non-zero values = ‚úÖ mapping

**Check TF chain:**
```bash
sudo -E bash -c "source /opt/ros/humble/setup.bash && source install/setup.bash && ros2 run tf2_ros tf2_echo map laser_frame"
```
Should show continuous transforms @ 1 Hz

**Save map:**
```bash
ros2 run nav2_map_server map_saver_cli -f ~/my_map
```

---

## üåê Web Viewer (No X11 Needed)

**rosboard** lets you visualize SLAM from any browser on your network‚Äîperfect for SSH from Windows without X11 setup.

**One-time setup:**
```bash
cd ~/Adversary_DRONE/slam_ws/src
git clone https://github.com/dheera/rosboard.git
cd ~/Adversary_DRONE/slam_ws
colcon build --packages-select rosboard --merge-install
```

**Run rosboard:**
```bash
cd ~/Adversary_DRONE/slam_ws && ./run_rosboard.sh
```

**Access from any browser:**
- On same machine: `http://localhost:8888`
- From another computer: `http://<JETSON_IP>:8888` (e.g., `http://10.250.240.81:8888`)

You'll see all ROS 2 topics including `/scan` and `/map` with live visualization. Click on topics to expand and view data.

> **Quick mode** (no build): `cd ~/Adversary_DRONE/slam_ws && ./run_rosboard.sh quick`

---

## Build a map (3 steps)

1) Launch SLAM (pick one):
- Default snappy: `cd ~/Adversary_DRONE/slam_ws && sudo ./run_slam.sh`
- Lower CPU 10 Hz: `cd ~/Adversary_DRONE/slam_ws && sudo ./run_slam.sh 10hz`

2) Visualize: `cd ~/Adversary_DRONE/slam_ws && ./start_rviz.sh`

3) Move the LiDAR around to create coverage. When done, save:
- `cd ~/Adversary_DRONE/slam_ws && ./save_map.sh my_map`

Tip: If the map looks noisy while stationary, try the 10 Hz mode or move more smoothly in wider loops so scan matching has overlap.

## RViz over SSH (X11 forwarding)

If you‚Äôre SSH‚Äôd into the Jetson from a Linux laptop, you can forward the RViz GUI:

1) One-time on Jetson (enable X11 in sshd):
```bash
cd ~/Adversary_DRONE/slam_ws
sudo bash scripts/setup_x11_forwarding.sh
```

2) From your laptop, connect with trusted X11 and launch RViz:
```bash
ssh -Y eagle@jetty   # or eagle@<JETSON_IP>
cd ~/Adversary_DRONE/slam_ws
./start_rviz.sh
```

Notes:
- start_rviz.sh auto-enables software OpenGL over SSH to avoid GLX driver issues.
- If DISPLAY is missing, the script prints exactly how to reconnect with -Y.

## Troubleshooting

| Issue | Solution |
|-------|----------|
| `ros2: command not found` | Run: `source /opt/ros/humble/setup.bash` |
| `Package 'slam_config' not found` | Run: `cd ~/Adversary_DRONE/slam_ws && source install/setup.bash` |
| `USB device not found` | Check `lsusb`, ensure LiDAR is powered and connected |
| `Permission denied` | Use `sudo -E` with full sourcing command |
| No `/scan` topic | Restart with `sudo`, check `ros2 node list` |
| SLAM not mapping | Move the LiDAR to get scan variation |

## Architecture

- **sick_tim_usb_ros2**: Python node publishing `sensor_msgs/LaserScan` on `/scan`
- **slam_toolbox**: Builds 2D occupancy grid from laser scans
- **static_transform_publisher**: Provides TF tree (odom ‚Üí base_link ‚Üí laser_frame)

## Advanced Configuration

**LiDAR resolution** (edit `src/sick_tim_usb_ros2/sick_tim_usb_ros2/usb_lidar_node.py`):
- `ANGULAR_RESOLUTION = '1.0'` ‚Üí 270 points @ 50 Hz (default)
- `ANGULAR_RESOLUTION = '0.5'` ‚Üí 540 points @ 25 Hz
- `ANGULAR_RESOLUTION = '0.33'` ‚Üí 810 points @ 15 Hz

**SLAM parameters:**
- Default (snappier): `src/slam_config/config/mapper_params_online_async.yaml` with `minimum_time_interval: 0.05`
- 10 Hz (lower CPU): `src/slam_config/config/mapper_params_online_async_10hz.yaml` with `minimum_time_interval: 0.1`

You can also launch directly with a specific params file:
```bash
cd ~/Adversary_DRONE/slam_ws
source /opt/ros/humble/setup.bash
source install/setup.bash
sudo -E bash -c "source /opt/ros/humble/setup.bash && source install/setup.bash && ros2 launch slam_config slam_usb.launch.py slam_params_file:=/home/eagle/Adversary_DRONE/slam_ws/src/slam_config/config/mapper_params_online_async_10hz.yaml"
```

Rebuild after changes:
```bash
cd ~/Adversary_DRONE/slam_ws
colcon build --packages-select sick_tim_usb_ros2 slam_config
```
